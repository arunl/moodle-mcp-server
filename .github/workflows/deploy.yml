# Deploy to Fly.io
# 
# This workflow deploys the MCP server to Fly.io:
# - Automatically on merge/push to master (server changes only)
# - Manually from any branch via workflow_dispatch
#
# It passes the commit SHA and build date as build arguments for version tracking.
#
# Required secrets:
# - FLY_API_TOKEN: Fly.io API token (get from `fly tokens create deploy`)

name: Deploy

on:
  push:
    branches:
      - master
    paths:
      - 'server/**'
      - '.github/workflows/deploy.yml'
  workflow_dispatch:
    # Allow manual triggering from any branch
    inputs:
      environment:
        description: 'Deployment note (optional)'
        required: false
        default: 'Manual deployment'

jobs:
  deploy:
    name: Deploy to Fly.io
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: server
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Setup Fly.io CLI
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Deploy to Fly.io
        run: |
          flyctl deploy \
            --build-arg COMMIT_SHA=${{ github.sha }} \
            --build-arg BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
